name: Crypto Monitor (Debug Mode)

on:
  workflow_dispatch: # Apenas execuÃ§Ã£o manual para debug

jobs:
  debug-crypto-monitor:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Debug - InformaÃ§Ãµes do ambiente
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ” INFORMAÃ‡Ã•ES DO AMBIENTE"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Sistema Operacional: $(uname -a)"
          echo "Python: $(python --version)"
          echo "Pip: $(pip --version)"
          echo "DiretÃ³rio atual: $(pwd)"
          echo ""
          echo "Arquivos no repositÃ³rio:"
          ls -la
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      
      - name: Instalar dependÃªncias
        run: |
          echo "ğŸ“¦ Instalando dependÃªncias..."
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          echo ""
          echo "âœ… DependÃªncias instaladas:"
          pip list | grep -E "(supabase|gspread|requests|websockets|httpx)"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      
      - name: Debug - Verificar Secrets (tamanhos)
        env:
          BINANCE_API_KEY: ${{ secrets.BINANCE_API_KEY }}
          BINANCE_SECRET_KEY: ${{ secrets.BINANCE_SECRET_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ” VERIFICANDO SECRETS (apenas tamanhos e formatos)"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          check_secret() {
            local name=$1
            local value=$2
            if [ -z "$value" ]; then
              echo "âŒ $name: NÃƒO DEFINIDO"
            else
              echo "âœ… $name: ${#value} caracteres"
            fi
          }
          
          check_secret "BINANCE_API_KEY" "$BINANCE_API_KEY"
          check_secret "BINANCE_SECRET_KEY" "$BINANCE_SECRET_KEY"
          check_secret "SUPABASE_URL" "$SUPABASE_URL"
          check_secret "SUPABASE_KEY" "$SUPABASE_KEY"
          check_secret "SPREADSHEET_ID" "$SPREADSHEET_ID"
          check_secret "GOOGLE_CREDENTIALS_JSON" "$GOOGLE_CREDENTIALS_JSON"
          
          echo ""
          echo "ğŸ” Verificando formatos:"
          
          if [[ $SUPABASE_URL == https://*.supabase.co ]]; then
            echo "âœ… SUPABASE_URL: formato correto"
          else
            echo "âš ï¸  SUPABASE_URL: formato suspeito - deveria comeÃ§ar com https:// e terminar com .supabase.co"
          fi
          
          if [[ $SUPABASE_KEY == eyJ* ]]; then
            echo "âœ… SUPABASE_KEY: formato correto (JWT)"
          else
            echo "âš ï¸  SUPABASE_KEY: formato suspeito - deveria comeÃ§ar com 'eyJ'"
          fi
          
          if [[ $GOOGLE_CREDENTIALS_JSON == {* ]]; then
            echo "âœ… GOOGLE_CREDENTIALS_JSON: formato correto (JSON)"
          else
            echo "âš ï¸  GOOGLE_CREDENTIALS_JSON: formato suspeito - deveria comeÃ§ar com '{'"
          fi
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      
      - name: Verificar configuraÃ§Ã£o
        env:
          BINANCE_API_KEY: ${{ secrets.BINANCE_API_KEY }}
          BINANCE_SECRET_KEY: ${{ secrets.BINANCE_SECRET_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
        run: |
          echo "ğŸ” Verificando configuraÃ§Ã£o..."
          python check_config.py
      
      - name: Testar conexÃµes
        env:
          BINANCE_API_KEY: ${{ secrets.BINANCE_API_KEY }}
          BINANCE_SECRET_KEY: ${{ secrets.BINANCE_SECRET_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
        run: |
          echo "ğŸ§ª Testando conexÃµes..."
          python test_connections.py || echo "âš ï¸ Alguns testes falharam"
      
      - name: Executar script principal
        env:
          BINANCE_API_KEY: ${{ secrets.BINANCE_API_KEY }}
          BINANCE_SECRET_KEY: ${{ secrets.BINANCE_SECRET_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸš€ EXECUTANDO SCRIPT PRINCIPAL"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          python main.py
      
      - name: Resumo final
        if: always()
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š RESUMO DA EXECUÃ‡ÃƒO"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "Status: ${{ job.status }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"